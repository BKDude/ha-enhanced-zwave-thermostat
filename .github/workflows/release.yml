name: "Release"

on:
  release:
    types:
      - published

jobs:
  release:
    name: "Release"
    runs-on: "ubuntu-latest"
    steps:
      - name: "📥 Checkout repository"
        uses: "actions/checkout@v4"

      - name: "📋 Get release version"
        id: version
        run: |
          echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: "🔍 Validate release"
        run: |
          # Check if version in manifest matches release tag
          MANIFEST_VERSION=$(jq -r '.version' custom_components/enhanced_zwave_thermostat/manifest.json)
          if [ "$MANIFEST_VERSION" != "${{ steps.version.outputs.version }}" ]; then
            echo "❌ Version mismatch: manifest.json has $MANIFEST_VERSION, release tag is v${{ steps.version.outputs.version }}"
            exit 1
          fi
          echo "✅ Version validation passed"

      - name: "📦 Create release asset"
        run: |
          cd custom_components/enhanced_zwave_thermostat
          zip -r ../../enhanced_zwave_thermostat-${{ steps.version.outputs.version }}.zip .
          cd ../../www
          zip -r ../enhanced_thermostat_card-${{ steps.version.outputs.version }}.zip .

      - name: "📤 Upload release assets"
        uses: "actions/upload-release-asset@v1"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: "./enhanced_zwave_thermostat-${{ steps.version.outputs.version }}.zip"
          asset_name: "enhanced_zwave_thermostat-${{ steps.version.outputs.version }}.zip"
          asset_content_type: "application/zip"